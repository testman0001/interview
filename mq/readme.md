# 消息队列

### 消息的理解

模块间必要的交互数据

### 你了解什么消息组件

rabbitmq，在公司维护了相当长一段时间

redis，也可以起到消息中间件作用，有订阅发布功能

kafka，有简单了解过

### 你用消息队列做什么，有什么优点？

1. 解耦：将消息处理流程按生产者消费者解耦开来，两者不直接交互。视频业务举例，入会退会操作完后，生产者这一侧只需要把消息投到中间件，而不用关心消费者当前是什么状态，不用关心消费者是谁、会不会新增或者减少消费者、有没有正常工作。反过来，如果不解耦，那么下游一个改动可能就会影响上游的业务逻辑，例如多一个消费者，你就得多交互一次。
2. 异步：是指将一个同步流程，利用消息队列来拆成多个步骤。举个例子，一个会议预定操作，分为会议信息写入数据库+结果通知与会人员两部分，用异步的方式做，可以在写入数据库后立刻返回会议预定成功，将开会消息投入中间件后直接返回，通知服务自己去取消息进行通知。
3. 削峰：消息中间件可以起到一个缓冲作用，如果存在高并发场景，后端服务性能存在瓶颈，无法及时处理完突发的流量，那么rabbitmq可以暂存消息，让后端服务慢慢处理

关键字：**解耦**，**异步**，**削峰**

### 消息队列有什么缺点？

答：

1. 任何中间件引入都会导致整个系统的可用性降低，系统多一个流程节点就多一份风险
2. 数据一致性，cap理论，网络分区后如果要保证可用，那么一致性就得不到保证，例如镜像持久队列，两侧脑裂后消息可能被消费，但另一侧缺不知情
3. 复杂性上升：复杂性分两方面，一方面是消息队列集群维护的复杂性，一方面是代码的复杂性。尤其是代码层面，重要的消息要启动确认机制，重复消息怎么处理，连接怎么维护，等等。

关键字：**可用性**，**一致性**，**复杂性**

### 为什么选择rabbitmq？

主要是历史原因，公司业务一直使用rmq，且业务代码依赖于一些特性，加上rmq功能也比较完善。比如ad、镜像、死信队列等，我所了解的，例如有的业务需要借助ad特性触发灾备处理流程

### 和kafka对比

缺点：

1.性能更低，rabbimq 万级，kafka十万级，

2.语言，erlang不是主流语言，学习维护成本很高，不利于二次开发

3.可用性不佳，如脑裂场景存在bug，业务代码容易用法错误，重要消息不走确认，消息顺序自己不保证

优点：

1.延迟低

2.管理页面丰富，插件丰富

### 如何保证消息消费的幂等性？

答案：保证幂等性，主要依赖消费者自己去完成。一般来说，一条消息里面都会带上标记这一次业务的某些特征字段。核心就是利用这些字段来去重。比如说，最常见的是利用数据库的唯一索引来去重，**自带的ack机制无法保证消息只消费一次**

关键字：**去重**

### 什么情况导致重复消费？

答案：

1. 从生产者到消息中间件之间，生产者可能重复发送。例如生产者发送过程中出现超时，因此生产者不确定自己是否发出去了，重试；
2. 消息中间件到消费者，也可能超时。即消息中间件不知道消费者消费消息了没有，那么重试就会引起重复消费。消息中间件不知道消费者消费消息了没有，又有两种子情况：

   2.1 消息传输到消费者的时候超时；

   2.2 消费者确认的时候超时；

关键字：**超时**

### 如何保证生产者只会发送消息一次？

开启确认机制，能确保消息一定发到rmq，消息投到服务器后会通知客户端成功，但是如果确认本身丢了，可能导致重复投递。消息中间件如果支持查询，可能能做到查询上次投递是否成功再决定要不要投，rmq我暂时没看到。最好是消费者根据id做去重。

### 如何保证消息顺序

单个消费者消费单一队列是有序的，按先进先出，但是消息投进来的顺序无法保证。只能业务侧自己做，例如丢失了某个序号的消息先暂存本地或者重新抛进队尾。

### 消息积压怎么办？

1.控制消息投递速率，这个一般不做考虑，只能要求精简消息、优化流程

2.提升服务器机器本身性能，增加节点，搭建集群

3.提升消费者的消费能力

### 如何实现延时消息？

rabbitmq有插件rabbitmq_delayed_message_exchange，创建延时交换机
